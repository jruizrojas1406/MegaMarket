using Cibertec.MegaMarket.BL.BC;
using Cibertec.MegaMarket.BL.BE;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Shapes;

namespace Cibertec.MegaMarket.UI.App.Form
{
    /// <summary>
    /// Lógica de interacción para FrmVentas.xaml
    /// </summary>
    public partial class FrmVentas : Window
    {
        #region Métodos
        public FrmVentas()
        {
            InitializeComponent();
            inicializarComboBox();
        }

        private void inicializarComboBox()
        {
            //Poblar Tipo Comprobante
            List<TipoComprobante> tipoComprobante = new List<TipoComprobante>();
            tipoComprobante = new TipoComprobanteBC().ListarTipoComprobante();
            tipoComprobante.Add(new TipoComprobante { IdComprobante = 0, Nombre = "-- Seleccionar --" });
            this.cboTipoComprobante.ItemsSource = tipoComprobante;
            this.cboTipoComprobante.DisplayMemberPath = "Nombre";
            this.cboTipoComprobante.SelectedValuePath = "IdComprobante";

            //Poblar Forma de pago
            List<FormaPago> formaPago = new List<FormaPago>();
            formaPago = new FormaPagoBC().ListarFormaPago();
            formaPago.Add(new FormaPago { IdFormaPago = 0, Nombre = "-- Seleccionar --" });
            this.cboFormaPago.ItemsSource = formaPago;
            this.cboFormaPago.DisplayMemberPath = "Nombre";
            this.cboFormaPago.SelectedValuePath = "IdFormaPago";

            //Poblar Tipo de Moneda
            List<Moneda> TipoMoneda = new List<Moneda>();
            TipoMoneda = new MonedaBC().ListarMoneda();
            TipoMoneda.Add(new Moneda { IdMoneda = 0, Nombre = "-- Seleccionar --" });
            this.cboMoneda.ItemsSource = TipoMoneda;
            this.cboMoneda.DisplayMemberPath = "Nombre";
            this.cboMoneda.SelectedValuePath = "IdMoneda";

            this.cboTipoComprobante.SelectedValue = 0;
            this.cboFormaPago.SelectedValue = 0;
            this.cboMoneda.SelectedValue = 0;
        }
        #endregion

        #region Eventos
        private void btnBuscarCliente_Click(object sender, RoutedEventArgs e)
        {
            FrmCliente frmCliente = new FrmCliente();
            frmCliente.InicializarModoLectura();
            bool? result = frmCliente.ShowDialog();
            if (result ?? false)
            {
                var cliente = frmCliente.entCliente;
                this.txtCodCliente.Text = frmCliente.entCliente.IdCliente.ToString();
                this.txtNombreCliente.Text = String.Format("{0} {1}", cliente.Nombres, cliente.Apellidos);
                this.txtDocItentidad.Text = cliente.DocIdentidad;
                this.txtDireccion.Text = cliente.Direccion;
            }
        }

        private void btnBuscarProducto_Click(object sender, RoutedEventArgs e)
        {
            FrmProducto frmProducto = new FrmProducto();
            frmProducto.InicializarModoLectura();
            bool? result = frmProducto.ShowDialog();
            if (result ?? false)
            {
                var producto = frmProducto.entProducto;
                this.txtCodProducto.Text = producto.IdProducto.ToString();
                this.txtDProducto.Text = producto.Nombre;
                this.txtPrecio.Text = producto.Precio.ToString();               
            }
        }

        private void txtCantidad_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (!String.IsNullOrEmpty(this.txtPrecio.Text) && !String.IsNullOrEmpty(this.txtCantidad.Text))
            {
                decimal obtenerSubTotal = Convert.ToDecimal(this.txtPrecio.Text) * Convert.ToInt32(this.txtCantidad.Text);
                this.txtSubtotal.Text =obtenerSubTotal.ToString("0.##");
            }
        }

        private void btnAdicionarProducto_Click(object sender, RoutedEventArgs e)
        {
            //int nrofilas = dgProductos.Items.Count;
            //object[] filaDelDataGridView = new object[2]; 
            //filaDelDataGridView[0] = txtCodProducto.Text;
            //filaDelDataGridView[1] = txtDProducto.Text;
            ////filaDelDataGridView[2] = txtPrecio.Text;
            ////filaDelDataGridView[3] = txtCantidad.Text;
            ////filaDelDataGridView[4] = txtSubtotal.Text;
            //dgProductos.Items.Add(filaDelDataGridView);
            dgProductos.Items.Add(
                new PedidoItem {
                    Codigo = txtCodProducto.Text,
                    Descripcion = txtDProducto.Text,
                    Precio = Convert.ToDecimal(this.txtPrecio.Text),
                    Cantidad = Convert.ToDecimal(this.txtCantidad.Text),
                    Subtotal = Convert.ToDecimal(this.txtSubtotal.Text)
                });

            // Calculo del Neto
            decimal suma = 0;
            foreach (var item in dgProductos.Items)
            {
                //suma = suma + Convert.ToDecimal(((TextBox)dgProductos.Columns[4].GetCellContent("Subtotal")).Text);
                suma = suma + ((Cibertec.MegaMarket.UI.App.Form.FrmVentas.PedidoItem)item).Subtotal;
            }

            lblNeto.Content = suma;
            lblTotal.Content = suma - Convert.ToDecimal(lblDescuento.Content);

            //Limpiar controles
            txtCodProducto.Text = "";
            txtDProducto.Text = "";
            txtPrecio.Text = "";
            txtCantidad.Text = "";
            txtSubtotal.Text = "";

            txtCodProducto.Focus();
        }

        public class PedidoItem
        {
            public string Codigo { set; get; }
            public string Descripcion { set; get; }
            public decimal Precio { set; get; }
            public decimal Cantidad { set; get; }
            public decimal Subtotal { set; get; }
        }

        #endregion

    }
}
